var wally = require('../wally');
var test = require('tape');

var blinding_key = Buffer.from('cf1ac6b99c6fadffe61a9f966bbfd926023d761b6e814e8c793cdb355dfd6d81', 'hex');
var blinded_tx_hex = "02000000010146eb362c8094de24c1bee6bd9b30d890f093950d06a6d82a99170066f773043c010000006a47304402205c8a95c5bd612ed67c2ca2bc1a1f4a11552ff60a3d99e1a5970206d17af327a402203d7c25a9424e56423949d12ea583d1bc45b33177e762c34d59f68cde5b65d90d012102e779a3e0ea775fbbff2a49bbce85de1646b225c9e4d3baa229613de0b7905c32feffffff030b77903b8767a0deca78507b4bdef1184a1c6fb394f12032e09d2ecb04c3b25e40083e9b0d54f27ca518dceb01c56e2e08deb2d14a3fa651e8a1244583055cc8091c03d1a2b9113931edaf3b1c7ef2a56ca1dc21e02fceeab05e355b0dea0572c8f45d1976a9144e3f246860a2b68ec593e3de1bd4bd7b6160f57388ac0bf2f6bda0728f986ad3344b7a0e2c7c977793aeb95da8208d6201d1a6a6a2886b08a5eda6791d5311c3017c228398a1cc90fd292dc47ffd5d80baffb24f28a098c0025911bf13502a5466e219de726ad6f3bfad48e35467bd3efa8a88f6b069c252f01976a9147998d1648d2be28cebbfb647affe28cf22f75caf88ac01f38611eb688e6fcd06f25e2faf52b9f98364dc14c379ab085f1b57d56b4b1a6f0100000000000008490000000000000000000043010001e7ed5ff14ffca45a2fa265f705de1008242499081f53bafc191399313f6b8d82bb22cf06cc35930d1e3cb862f6fa18a8396e24303d1c61f7b0adbb2fced75fe9fd4d0b60230000000000000001ce3500a06243b6cca4224824aa60afe8aaa41f6ee7a1089cb7a2a170ce54da319f9fc7313d3f3a724c65ecfba20db541b5d153eb1d1f5ef0d7af5c31d9a98495acf9f073d47a3f6c5e820c8d751d4470a22bccfc07839991b0feadaba9f07bd64f4dac21a61e505d19c9ed7c47e75afffd6db25ec5588df7f85f95ea92147bc49a388117691b36722c12a7c497ea9372687964fde8fa7fa7d5d9115960a53b8e0a4b8f96bc561b74aadc3ad5813c622d295620ab74a976278369907b952606798f07e919311eeacff715b32c98043f4e2408f03afb0a4e26bdfc3c7459e157030ca6a0465ba08f984c5b62369c8986e6d764cd11c3fa94d7cebab7fc995e458b1fba44eb4dad92b70c4f32aa67aa0e91a0710370473f639426ba750e06d7a7d1371b1d181324a5a103e17fa063331818773f94282abdc12766b7bb09934c50f013ab945022852b3f6ebfbedc5dd6cd21c57ae91d18f123e41ac4d21a1e1d4c6251c86ad281527887fc3951774ab2c3ee5a1b008182ed57e2c367da872a732b4919b905f53016236d4d0dec265bbbf39b68cc0c677a804cb53f6fa6dba3c29dc7371b8f998b2630a14bcdc811a8ec89c14fda4a3bb4067762620f1744e23246c87b8c2c999dcbce3ea0bc497f3017e10e8107fab350c02a1f02f0a9c2eddcf63865f3228447a529240ec6bd98ff99531e4b20a66618c7b8b26744311c08c6278a8bc037c512a5286d4abe033891665881f61e5d3adfb65931b691120e662fecff653cac7474136728f0c3ca0ecbb4227c92e902b90f66829cc4d627e281f6676ba604a41b742432947bba3802b0231b4c98a41f33d1c2587f67b5ef05ddcdcd040e9534de17a7d2176d06f24d618252e96169e8b187f32adc64d8f3c576a25a59bca1866fe0cd3662de90b7819e2ab32bddd1d1599718266ddeff3f49446270854a03a881f1f8af0d72173ac467ecb12acfaed197bee5c702ddc51f06155e4f5112fec50a742659fef62121a54c26ddcdf2a5eebbef75d8962ed8c4c3b739a56d1f5c844662716eb65f1d159774f80e262dea3d5a11c185eec713a9ae17c20b2d770f8818999da4b126abef4baca27f8c2eb8d5622dfed6896776e819f0959bfce20e08e7c56d8b2f72ba45c0d0132ece5f8922de8c68c1fbe966bb5e46b33465e6507d8f34643090ca28597b0d95f4a440b44d5a79e7632305a9b0a4f7fb7345e647c9113867f3bd6dffa5714a3c70e66d39456accceb20fd8958aa214c518ce04fdc019267ba5813e0e6c210981430205d3e345d479a36cd9df9d96886c918408df0466a95d75888812c3db1c45c34aff781af4cd1365fa88b065890716aed4f8b52e8381f2004f9b9825f6312f72c33a1cafb109ffe655b8ba0530991d7a54380500363312353c282347c2d2f273dbb4e96f2921f14117d0a5413ee2ebc069d46b18bfed7b85059fd58aba5d7009e8c210d1700fd2950bdd6db0e1a414bfec991bac022ac62eabccf518e6b6095d7ade74cf54750097664ee3bf6da1bcc3527255bcada619fcedb40f3e73237a7363f4ac173e96759d6a158369bce054eb8c51a88e1033d0b6b909ddfb66ea248557eb3f1260ba6ade24ef369351da17290c8bde0780b37f789cc202415af381d9614df98d3bf035a023513e6ad839dd4e688a0628f5386dba992ae5c94680ad1c1c4baf09c36ae9442e8153a2331567cd76a19e05542d4259e614b39dceb67d9f3da762f391035c7a7d74962aa520b296c64c75308508480c5903be6f5f8bd73046ffc99159f21845ff5ecd1a2842a23992cac88421e29c5160e05a997a6230fccdf862e470dd9d73dc1a0026b44f69389a316360fb44c1994786a16bb52566920b9e1e561b59f35dc2f8b03188ff1220482e8913719ee321c92f592821d667a6f93657d96a322e9272fec4b2da571546863a569e460ff395e42b5d079ba5919a8515209582cf5674c8262a90bc032a83eb2b2a38fda37979fccd3053eff59ff16c5c13964b5466f3655d17b49d08a0494ce22a2c33a338a1854ce1a29b23efd6046b6382d43f2576c81f2e44e1219abea6a558e1805e78d3c3a476e0023685c5f53d17b2a5c1f233e1b673ad941a54de145a46a7052d5ef34fe1da363ea4bfad9b2c8d5b75826a560a5a98d7c81a16fd4dead893688bb000386c122e311469529e998cf18fd246a2e96f75ff820f14c908b1d159ef29ba36857f3280ee1416dccc72003c38b8aa3647f3642f0d3f2bbfc8b8edfe5a93f80cb44eb2ddaade8b610c086ea226280058f09e90d5ffed7555a23439494ca17e608f9215df8ed6a95dd19e2463339b06627b65be60ff00cb55fc6c3da831dad6d71154acca29aa8e27b914ef9fa3d651b069756e2cafdce5ca7ddae70c638afc01d46bd37adacf4774c7ad0c37b5af94b4d64c4b654256566d6319ca94d242ba39f3c813f820e982ee91b67559b9f58593206e7b168b99376370a2ff12f218f2ef2df0fdab771d54baf341a76e8379978587c0c695b958ed182dda68f65eb72942b058d72544d3d3a23c656ec61cc3192aac9cdabb60f96fdefa9a1c5ea82a816331834d37ccdd3b45ca9939acb0fd1126737f342cf78ed6b5abb1ca38f045de863cd2f46052892484fc3a0d7527f71f0fbd62332bb539a365ce5734ee74c9de2c923340c90b0fb74bc4c09ac4a5634bc50576298896566d43ccfa0ee719a6ab1ee08b8c07953ed372ae1e2e39d1af03449115690795e25acdecaa061a97f8a993fcac92b656d95f4e770318b6c0ed8978c2f7a561ad0b8b9b7dd5037b280d40e31a49a6489dfe37660e43b7ae3846d7461c5cfbc43b9426d9d3691c228b10c7b4eb20e799b68828a5b4fc80317eed48cec219ccb4cc2877e247e3553cf54568d14130e35b7f361ce8771f0721cf8c56b2f175b78bfed87e0e39b8de3685457deb2674ad088092fad88b71893605dd5606a4dbcf1a722c7c788a6c65488880ab8c9e7c13767edec6bc25793d5fdf479159f6cc53e64f32e84b043daf42b8b788dd3438dc6f7f159bcb23d6b700cc3da1f539647aa1b8376de5a9dc34218b1f4c29f20bd90d7efaf0653029279f604f33744441b5b5f6947f6d50729c4ec15948dadcb8e38ca371e63a94a11ea44afa40a6c3b7e02721e33c5a1e2449ca97218edb96007a8655f994540e88df8e513b2dbc5fdb9827d5619b920be4451d38ec00d9983665e8778df7e2c7c957a47dfba10a09eca8c854354fafee1feb1547905591be43b6aa7308c2634a51173bae821aed392a9ae5b9b2196b499158be8084e96b2f80bfd70c66719f67afbe3b892adbe124a5887aa5a8dfa5d38b211f417bb9c1ecad8b15330ea3dacb1a563a84cf4eef781172d9585d397d8f01b18125192c4ae201da3160c5ec3fa05b98b0619ba6a2008706ba0587e3f727227e0ca43b4cb55ecbd648082cb917d5f78abf3b9376698f1387ec199e9f0c1006a35a6bf78f7d51ca6e2516e890cc77c0f1368b908e431beea6f62a62eeb617057dc98ac8fd9e613de48e21b2bde6449378648955d443691d33e74fe0484471dee2c2699f064ae54f8bff02ae9fcf3f9c109c32493ffcfc22cd4b781fc8f844323a31d48d376de2a545fad0ed1d62b1bb1336585ceff787c649ad48f598e07302c0f81021bbe780b9ef35091d7c190200297b69395232d8de30583f08565cc0c3b3f52b3bea029a953cbe5058f28b378b7d57dd978ced7d0ed73116a895a007fc6c071f49ab42d3f42e1bd60707a7ec00f04a9c14debaa1fb2578b46f52ebd525440f0d6b924be345da03d132d825db29eaf57c8a763b4a34f701a0d6d9491de1946ef56d20e2495baaf2c1143ce23422145d336ac651a43425e75f583a29b93256db39da12b8450da470bb5a2f3275c57a221385e4903ff279de5cf6eb0984a8ffee054a0bd6b8bd967ecd0a95db6d6c1c9cfcb1144a9926296cae3ddd7ccb3e7a65585fbf0ec7e32c490b88fef33f1d5466de8279554850f5f14c21731848dc70906db769d9817fe0fa0ed780161552a53a1a1b9edfde6aed141b90ee9aa871272443010001dc9d259729b8eaa1f2bcc6101f928f98cd0645b1cf32b086e029417ba69121bd31a510c4c60d5cda05a30882d9faf1262463f8d478ff7589af4f8fb854df6a76fd2d0e602c00000000000000019bdd1f2acc1d47e2123cd5eb922dee138d2cea047fe249d7d45927b10c44f4c723e7943a8010a9a6183d2c38adaa40e75154af28ae48f784dea5f94fba5f66d6cde61e4700debc0e595b0ffb1eaf9588c01dd98725abe381ccbb6f86c027ffa359bc1451f45b8a225f6ce75fd146f4cb4f7d7b0c5c9ff256558c86280dcc9624d007becacca2c8a48851505833c27a4e5fd81254b198c9ee92867faeb59ff914d520cd7c06ebfb91409ff1cab3728dd83b258e0945f9cb45cfb0e25744c39c6de8c0b3f11835c2ef9bbadac9cbdd43bdb62ec940c9486bd46d17bad5b8eb98950610a610f2d96f6beaea7d84e541052f568fa56cd7a900f5758d2cc3b86dc5481b2ce3ce9c5f75947550d77d0e33ef94ecf157d1d3d607a2275206f3a5dc261963d6910e3ecf55673d12df0ff765a77af4b2d2f4e4726b089b7723d3bbe5d19f0a42a5af9e2172a769ebc81027cbd19f72c6221ac567bbc48d4e8930d4737b4142b4cb32b5fcfbff31e3365ec071a6ea5491d1a47e3a572228a7047facac4f2d727853a821811dbd77fa071897b6ef36e1e1e95ddd90b96ab810dac4ebfda511b422e555159f9a3429095d3dfcf9b60531e8f4e322237a3811b47050cd09865a5857c1cb7f0905a59a8ffe96455e034f8f9c50239aaee06a72689bca10791127693950561b8f84d9f1ef7d1cb6249c76db146f4e1223d26d6b6db622d0cf8858d14ba742d2ddd3685b04ff1455a847646473355a98f53d2b8322c442857cf246e7b217736f61ab6c9a751ddb2c967bb5d07a553abadfcca066444dc8a5ef199eda7dea0b3551e8ade110cf35ca82387e6f4a7274525008e2bc258997e34cfd95b8d57b58689637b6fcba5bc11a7bf5b0659f77ef02f08e05e3ac07313e0b127d68b766328635a4596262bee5780a08bbaf3cade245a30e827cefb73872b8bb2c0549133fca18a4ae1cd3b3306a111d746098ea1dffbe3af93adfcd00a8a176a5ed31622d169d409edc15245f94a1957bed54d67e792287ce39552d31e8adec8a6a6c064797f098abf898e94158a49cf256574e9c5dbf39046409ce7a42d6f81c336cf13e088737b3b064f342508c8c7007fc3840aa52fbcc25f7aa0f27114f120e33657631b501ae21891bcc04dbccd048c677f6cc1a28d2043403c8da041e38cbe1c748338caddcd910a16c3603b4b4c126155ea21eaf907358ea9d3bcbe6351c23f422939bfd53486647a17e3a9e9a68a1d3fef1b412c99d904efb1f6fb22dc4ede12bae513490acb2c8856f76adf264617e90df7b0a5883df594618e3d640e4193605d8170771cacdbd4e74a1be542c2276cef5f09f436fa6ba033a8ffe322ad56558e488b035c65232186fa0be9c21e1299d7b4d0c1d5c33d2d2b2f986ace3f6abc51641084490e85ef65c3e0181ed0473fac36d9e27ec516fc50997481d1c2f0ff9c43493f334754d990ab28debbaae539bd05e494a443d0906ef1158de5123f4d9fd0ee72f3399e7b6bc9630e4798e7c026bd51e5fd9bd17300843e676b6e66803fa4e8d5aac00ff4506ea22a0dbf1554c203a54a4355de1b77434adc804177f33bacfeb3b6cb591841aaef18ca44b5468b0acbc196f12403d142e729dab071959ea381b8b85e17097c8b5cae5921e9c13cc8c8c0583422591c2822078b70723cd08c438932f9f47fb09c446c645b76a427a486fd83a4c96de009171750c82a7f6d0cee1eb4dc8d05ff6b6520bcd6ecf0b72920764c45ed8d10fb83a96ad880563a034030fae3668517ebc36602ded201215ab23fc47b3e3edb2ec65e9cb8ad0577f13ef5321aba701aaefd3a0d3b263b4b3ee25d0fec4f9c29a8c511172ede016acc034474eddf238b3cf1ce48b4e148ad72ae5118823ab8c684d83b26366eb00871e873fe625652e988a458b4cb1b5481a53a021c5b7c0ca3c009a52059e4d0bb4bc8195a970ff293bcfe1f810c6c92883244fedeaba8222fc135af590e4de89d22ab04b77e5efdc55065cda8df296b7d7b49bf02b94709133a6e63dace640448fbecdc58233637379013eda52138eb6783b9fac4635c6ad3a54b7173fdefb4e14d0aac41fddd607198d61d2caa463dd2251cc001ec5dd0b1665853973e6c83a2c0ba9592b26bc3d2e9f53efed94b99eb33736b79e500152fd572b20c0f2019981f084baeaf70892cd0ab55c2e7bad1d0a8b59cd4ec3cbee05241c8f1beb29be700afd22c40721bd3d437ae7cf38234a2324378e50120beddd7579fa4e83f77a90960390280ef92164a55414ca22523afe7499ff6f82a2f95d4c41f06d992ea8cbedae565951f64b97b892ef45a01e0c67aa8f84f29bc77884a58777e885b91a1b6004de3210962b9f725b8292f42404d5d09df6ff638c0f5b927e8ec83a80c5b1b472916ea3dde20c56cdfd872af4d207382286b75f9906952221a872286d03efb152ac66f01655fd0767f89c73c2e92f62f047e3ecb5853f146f5b060742c344d55307a23fcfa1102b83e84ec028b37c158e7010495ff500219fb6847b84f341a255df0311de4ff22532d876f0b4ffa1e3d52c4e992e94dff8aba2fd3f750e7ff17923cb5e9077fdfb119fe6d13232f1258f3bbe585700f46cee18bbe958f0e1617fdc980801a492286256ef947cbbe987bf2852992a9999f30eead59925fc33cdb4037cdbc30ecedc06bf7b62ea51263cda8088f06bc833ce0329ccf33bf70c6bcd5396d4643699b31afe078565aa8a8dd8b4c665ad89148ca9088b59478b7cf73a08e077d47d13305dab23beb73abc6661b23430efb8f9fd02231ad189c1fb90f2b10ca27ffb9f8353d4fde3529b35d40a14890ac1922f184c2bd4c4c3b63ff79125e6c7b6be73d4d74411df38b8dc72d509114cfd51f8e4e576a79f5e2813d74a1cf125516f78dcd55f78bfe34d89cf7342d69a729af95f7f8f60e07eaa3acbf94d90eb60c65aa9c777b68921af2e2ed0cd10728e58ddbdb691cd86ba9c46bdf5855ddd2be717cd6ed6f0a788df3a00cf5f50d8e14d6f804575bf6322f0cd76142fe1970013e0b3dcca928c8fdbae85432a61fb1ffb3334f61004cb1f88501480bdcbaf89dd74b93ac8b19bcae8b1a53f7d7900774fafe49ac015236926b666a43099ac85fcf1dd05291928a0195a3ba0b21e6cf721b34ca99953b1b80062b02c7526d24303fe089c120d12eb94764284bf2a24a382a8c77a4ff4f2950013a0cbef292873f8b1d2a866bcb53a93cbe378189d08127385708497a38d1ae3cb42a47f53d8bf9c780b84b453e23dcd419321cfca6b63e8348ea47a6687024299e0f9e211f296eb31772d6751d8cf813ad3399beac6f11285acca5c9034085654e2c56736d43bab4d9230f69c818f499fa50e5727c9fb05c62c48d17cb46c6c01512d3136e0048a5aedcf796d038f6c94cbc5625afdb186040184a29a419e31bfa77a9909feae3fb10dcfb849a5fbc946f4a9456e53ce9283edd67ef409e839a159e311c6afd2571221a733816cf1b93b8656b0c0091ce5218799a49e27fab84079067b40aed9549e8e4c905f07609b9cd8bceabd93ad942d7bae46c56985815ac43a7c35aee3b355b4bd180b49ad0f208cbeb1ff7e9f39f8b709c97153604fd1b641ce9cf394a3a230fed775dd2cbfb48cba96f7b2b91d88d0de89eb47ddbfa23b2bbd3e0dc182d293b7e4bc6fe933a7c70bc939d623b4a2ddeaeee46833beeb67b5c016c255a9468cfec3184ec44710745969d304dd4a537ff084efb3f5c7015b0b64043f12e56e80d2cef31409f5e0a1f8d456e1a7c0d9155f97b8c0cbc25ff264e884413886cccb5abb9fa8fa23a371c316bcbf4c7849c5a0491a20bf4e051896c0e7456e009096cf331bac2315c47dc892a0118ddd67819f1c7608ecab473032c68594e8b4c05543a39ddaf58a9dc5080d7f83873209314aaf70fc5e265d66c5a84c0872771d4af208ca47768ebc1b61a73d3aa616160d6975d4368a9838561591a8638db407edd38e654259c8b6a913233e1600000c0c18d2519dac8ee1c5d48348e636274aeec01c4f70f52024e8de3189083f378b98565d556e2977f4d5607fa9c3e4e13e6267d6df2bc57d21767fa23135fe25d7d3ab4d80d8c475560ae5eed29e8bbcf0c7c9ebe72354f048c2851cd589b9f8b006f3e2d6c924493bf01a1d074d8edfc0a8cb671351f69753cba790cf100f2c8738798aa60e04ae6e21080cadbead508c19f282409459eea4a7ef559f3230c41557dbadc62c3f073fcb92f87bbbf484cc3b8d5c13dca4972946aba97f6afc0f375478eade724fe5667980799d6019341df26d07b0afb7bad89a22717775b4a70b5d1f255bcc323376e3d7f39cd7cdd4fa5269de34f9d7bafb58b8d7568bd06d493afb8563f2d8b12d3ec115070049e0606e9a55496de32dd90923bc1f10ae2123cdd209153cc9e98dab44e982a6aed36512fece2157e538c1de9e710007bb589802bacdc97d83ca9b94591d8c06779f5c168a32356cb16e5af78ba479fb9c1bf1059f152897a055e235e3276f4632c8086ebea48ebfee1c7a2bae986001e890cb64b9ae8b9310c4fdfa651cddda0e20cf81e23d31f099a6b8f96f6212addb54e9c9fd4fa51e58a94bc00c21e76372d6f3438767b6e75c30ec7f21679cd1dac010a2f494bd0ba511927a661545086f72ede7396887a295f0d1bacfdf12d34c1bbb9b537b6e7be62a71874fce705bfaf3f776c842de1f55df258331f13d0c4c566496ea2dee161920afe79cfd5bd710ada9823206e8d827fafc13b3b0998e8ab26d7aac8b95da42591ce242c1798adcf08b30fd629e09de13a30ae5d776e2a884acce4a1d7eba55729359dd4e86e65a0286b58eeb7194b56ec810dab1a952519867c84bcaf3bb2e64d4a7e31da8a21ebe3668bedf9f4d55d1c55942f020f3c9c94ae52c6bbe58498b788c833ecb7406739bbef91ae71d0ada907476f972f174ce5ab0c8d7bdfbdca4717847bb00c9efc823d87919357b951d45db44ef7ad6105b2d306b5f38132e6fcad4f89a779dfdde9f1db14350e1ebf4e6c00ae0928275d3ee68bf601a52bf3b472e4075646dcff099073fe5725b116dede9ea32f0a64083587db3c333e34a0000"
var target_idx = 0;

test('unblind', function(t) {
	t.plan(6);
    wally.wally_tx_from_hex(
        blinded_tx_hex, wally.WALLY_TX_FLAG_USE_WITNESS + wally.WALLY_TX_FLAG_USE_ELEMENTS

    ).then((tx) => {
        t.equal(8478, tx.weight);
        t.equal(2120, tx.vsize);
        let output = tx.outputs[target_idx];
        console.log(output);
        return wally.wally_asset_unblind(
            output.nonce,
            blinding_key,
            output.rangeproof,
            output.value,
            output.scriptPubKey,
            output.asset
        );

    }).then((unblind) => {
        console.log(Buffer.from(unblind[0]));
        let asset = Buffer.from(unblind[0]);
        let asset_blind_factor = Buffer.from(unblind[1]);
        let value_blind_factor = Buffer.from(unblind[2]);
        let value = Buffer.from(unblind[3]);

        console.log("asset: ", asset.toString('hex'));
        console.log("asset_blind_factor: ", asset_blind_factor.toString('hex'));
        console.log("value_blind_factor: ", value_blind_factor.toString('hex'));
        console.log("value: ", value.toString('hex'));
        t.equal("f38611eb688e6fcd06f25e2faf52b9f98364dc14c379ab085f1b57d56b4b1a6f", asset.toString('hex'));
		t.equal("f44af3a58cae34a79c5f4f51304af0b6131188965c31148b601497345218cfda", asset_blind_factor.toString('hex'));
		t.equal("664db2ad785de59c92e1d70c23c3d2804613de2cdef0e545c66cb66214093dc8", value_blind_factor.toString('hex'));
		t.equal("0000000001f78a40", value.toString('hex'));
    });

})
