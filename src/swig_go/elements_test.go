package wallycore

import (
	"testing"
	"github.com/stretchr/testify/assert"
	"encoding/hex"
)

const TX = "0200000001011cdbb762622c9bd12f25af3d26008545ec7acc73ca453333122ce00a98e0d3cc010000006a47304402202d0d77b3eb9f808d8fb7e0618af5ed2e6443897b4b78035e0685dbb5753d8df90220622d1d723aa28bd927c7736079a14f63de3e90a3f55b9db1ca857c092cb4fd350121033802759b0b17cbd3cb5f9f90fd09d48acfccc66f3b1de1c7401673653dba49cbfeffffff030af0b1dde392af726d36edfbd61cf16a88f53f1b388288e3b72cccc222a6fbc1d409eb99b7b2c6c34fc307e47bdb91c595e9537a1dc14f9fc20526f844246f7bccab024ef199fab42bca0a31397d9f51fd269856db94f684192ef8657655721dcf217e1976a91412d64a2c140b7430978339a3515090519cdd1a5288ac0b19bce47e52da706515c923aa7736871efe7597c37f4a2ce9746536ac7af97a0a088ebe0bda50e90c12eb1b0b7261e11ecf335b7ec5e52206f8ce90f8892d3fd531027c40b511577e680a3954559ecfb2ab63b0a58e2c1801e0ff9e34a19584da4eb51976a91428515fbd4627774e79fc9f9aee92d12b2665b10288ac01f38611eb688e6fcd06f25e2faf52b9f98364dc14c379ab085f1b57d56b4b1a6f010000000000000791000001000000000000004301000178d78e0e2a0be9099af991728f635c5c0c420284c2a0f379857b84f56390d4917e8adb97b280a38f59264b1174b25962cc9040eccfadb48a073315826f6ae025fd4d0b60230000000000000001f1350164ea273e99ca93c60e52889621e508a8243e90a3b020b2a0211da60c1cd73fbc72bd8965ea098552cbc70cd810f8d5f0d0a8d826e939f5691b4eda309c91387a4c0bcc6853b6988a4c5dc69924bd2908f6e5a000177c8e41e696adc4d7c81339fab06b22ecd35977657bb7971770b27b95edc6bc1d1a91f2534869392667b15dfc1800587d318e89bcfd3d3069461cd0b4ad495af628dabafdf08e3bdb8f684aea7a891874f75373f2fc61f036d48a92da2fcd6b2866a702f7e6891018dadcbbb22f52a51b76bc2f9f05aa7974c617474c0418462783149d96d9e3a132d3c2a53643a66ee484e6aee34f7b0f12cfb05bc4a8fa0de4e07f1ef1796b75f22849b631d2669312f388d321272966a0b14a3ec513dd8da5842a5d0d938635e0babddb7b1e74df84339042e620f32f03eeec57b4f490e93e302d91db9ac17bacdc5ab263e868c810d12c87d8622e4dfef0dc459115133603dbb378dcea8d60caafaa6e814a38aa578f98c21bb4dba35980e39d83e5280c63248214694d396a5c8106c587d726de490d111ee3b537df0d5d3fd6b2d8e31c991a1d38a02649123c9b7fb09934d996eec28d3002486fae12f2901a4e56c42b72d67aa4c7626d7e998c80cb956d72e1e2ce5d220149c21a87ea12ba52c54133f28efada89d3c61a90be598fdf2f14f783a9011cb190ed081eefa44c23760cc50be9d48905b17e8281ea01c124bce8fa52c27f04db5529da2d355304a74705afe6ee2939e102d454e08d511628389c8ca7c52159ca3db3b43f12d3b4e45c4bac72f03c6f2912df9b10032fb050bdd69cfcef352a6b3379444c8125d4bbce12ae1c1490003aaa01f1a1fb9c0b54b185dd00ed671ec4509354f6dd7af94548aee2f54d1044e6d1db4b3e35a2ab70deceda3f41587dc85fd3f4fd11efd6f8af64175ce3f2378cb798dd8afbfafb0f411f5c02af648bd2aa1eb8d637d1202c8c26e639102109b9df37928a44baa995cbc33fee6daaf13ff5d353a255e0cfed727f217a0a437d33fbf0b199d5c153f8c237b2431018d0eea979b9c607e84ef7c887026fa5e2caef769abdc1946bdffee6afdd4c014fb5a6936169878ccccba2b3f5279891dd90397b4f610b785a18fa46aced4a3a1fc156a107cf61c008a91887ad5c23e5762a42337bb16ae890c7c736e31726e933aca7cf574fefe3b3077ece9513fd661e2ad0ed431cdff12bea5133353a2db6e9076b66ab060779f8fd363c8bf97073b88990259ad386c17412f0b17f554b95c994c6772a1aea497c7c670a5ae253dd1d20858e415461f446b8aaf1613700da704ab760f11374a1788e2487c40c353de83987126bc07ecfc6da2156641863ccb0be74ed407eb6af23cd3638226f2ecaa9d4d6ab547d327c9646b80ccb0ee9d9b919cbe3bc7a5d3b87fa330ef8e72130f7ffc07d9b62746fa314dc932d1d21d638e26deaf190a237e9629590ce8a663dddc1dfe8ff46ada4d8acc9ca95f38cda574e1fb7bbb46d32cec4df03204a6ad0fb51d09ec7c68fffe466b3ca5aca58d5bccb76087996eaae44b06fceda24c470533e9d1a471cacc6c47570fea13fb243fbaeeb14b80e80e9af3091b66912aa6433513f57ec625f7de35584efcb1fefbb92d47b5a6366182e682a733c16dec00cb909454395f522929c15ad54678195e583e30e390c10aa8d0f4bfa8a012f7a6a4ab8aba6432cae19cd171c4fb58ac11f4799c882db3b224361efca87302a08ad3e3fc7d83af8db605006959857de1ae9888f2d424f71756ed499ce5799d0266903febbbf9c0705d5bd0a8a7ae2229c558af89272d2c5902283fb547c29a49b979c54f7c13ae32e593d3b5b693147138feefb6c37cbc4038c4aefb80a9e401ef4e317d909f3105d04aa5e9a3ca680ad746095bfa98b4484713f15836025f43b1385a21fda381cbb270cf117dea214e8ad6f2c0bd340678e775c461e047b88a7ca0015414087018b5929dc298025c6a4f8c3cc8e99d33fb0dfd286ba4aa00fbc124b67f2a161de2ce5798496c68a4f77e50223d0af6862e3516e310aea69411f676af98700051974891f5a7daf0620e5187635234e50f16b6b48dddc3e8d68d16887e0442d19e4f4262b68046a50cdbe86867edd10a105da5122726a989916883479b8f5974d4d4e1ea1564bbb72d67b9833f9b86e8b1dd31e87f9d34f8348d4b4f45d973c6e3c299514da59eae9c10c68e386a6863af61ef9a57db17e7c97501e7218beb1ca9270d8a4d588d287c7903e04fb00e954074f2ec7000c6f72f777fac19615689bba7ae788904a473dcf20e212d4018b80199ff68206daeca0e562a4de39c64396ad8b4409d52dc60971ec166d1941da861acd04a931df28fde7d77633e291da48d5cf89f7b80c505be82def4c2a21292be8a5bbf8ab6561526e6bf5387afe2fb83546eef60199623676b28997b3dcd1a9f1829a468d8fa7b3159fc93b95ef04f4373335406583f16938520e3f980816d1f2bf94bfceb11a90ab01d3918359b9281f1cd9fb321a0aa9414c7673559d129f3d9dd15bcde1588a738457d9aaf3df2b4fd6b04700a1b781a697465adae4251fbd288d3d8e870297b4d8cb778b86e486811b9c5ceed4a4f89d4a14f0923e5726cdb5a804dd7f0632f1439badd6c25b020164157e1001faa97c9a990de58da395c30f85bbc62c76c8abae64c24d417797c7f45ce991855e40fbea0ad725d73a72e6bbd392db6681a5b1ade0b3e6cfc23fb2447839982ba1fa3e334af5127662db27ce1d56b96b11e7ba1cbd8713ead0678c1958401a5f6454c967831c5e9acf20392a692f321f03d97c3793083ab8a18356ef05cc78c1185d1ba3d62c5908a93868dcdba8f14005891ed7c36a5acd21e6bdd2f937673a2157959c63583646e90e8edd2709469d11de274e8d019dd2efb91d1418268e09c025fc100f76860c1c4b57e9a9877c9aac1f8cef69f608998d11827281c1ce6df62c407db0943f0d6e04aec18231dc9bed1cbee8976ba65e1bbe1512161553f9e2bbe0c9a236ce12b918c921af2f8da68d693f1b51e9c82b5313ce6a15b7abad09dee01a6072d59243116104e39cb89c139621fe5ae8ca9d474de58c764883ddb79b3d11c72d0055be09cd53e782e2e0cbd69d21361fed315d0740c9e31043948081842b28e553a0055fccd95209bc33a06e334a73ec604aef7627185d97c596f729dfc0fe2602f58f1c99fcf410b4c5c1fde4fdfc3b5268d67331ae1cb34950451e4c97af36b017b52ba1fd548f7611e4b76865d4bf6c44829780ccd031b98a3d046466b8b94658ac20ee7d6b24f2cb278f54d3b13958928b0ec1c4431436169c74f4a5e1dcd5afe428cc054c6ae7621dbd52d18339a229aff833fb7b980e6ca76b3da1700b31a7039bb8104a91112f1d2a533680db7d829ce96eac2f13a7e2492de6b5b3b9dcec1c952ccd3d65796c03dda98420265e69802030d2fe53b447977d0832db630876c901bba98f891474b484852801ce124c6b743330fe2e9ad4e87408c8b82d3fafa084c6042b651f5532aaa07add97ad5f2c43bd77d54a5add52c7ae6fc4e9ee127e9ebaf7fbcd9e8b9fa51654d2a2699ded731fe9e7a031a7b7e976b4c580d8abc11518a8b461bddc9d888841f429be31185be78f4d34f74da99bd6ed9ba77e249d26e88ac02e4977d8a9efabb13f61a283ec3180f447e76b56398bab4382654991e5e3edab3cd1d9b893e99f37cfc1ce700a9178cfbcaa329a395886e86b5da486ab07272982a9035aef3cdfd4f4e0a1237c4ad9afb3bc320ca65195846ab6b506a79c4cbdbfc77042ea887590d8deb939a4fb9b9dbaef69ef799657c66f553d61651ac857dd8f243965749c43c1fdf3e622355cfbbc2428e671a2795c55c764f5f916a58c8d5b8389c2c9ea56969900596ea4b85f34dfad7f6a6157c99dfeb1d4c747a71a76b568d67d311d40fcc73a9d431a32e1428afb50b77ad2754554cd351fc6ab05b30dbf287429823ab045da205f77da2ab7f9adf89ba1489cd448cab26e01406acd1107d5f895e4b8e067980f35042b72a9fa43010001fee2c7a53703e40d631b1924a46f97f55fbccb2bf90ca094aa5914120906a366229265181344d0d666c96ca2e60b7caba171da5672ec8a0edc58ac077aa49244fd4d0b602300000000000000017aef008c74856b6fd766853ee548f179de6a986defd25f38cd36c18a81398be347569a6b0db492c47cd22c175cd5a21260387d417ca4deae5c3a532497e933f2a736b526c4edc6677034bc4d9cc3052d600f8452083da2c1dae59ae9f1b386629ed0af3663cb08c6e64edb4152f22e92597e6fa7ff49675ba28c65840113527b36458cb1f05e443490e22506433f6907ce639f1b36597aeaeb1a01e3497dcc9630d76f2cacafcf3857ddb07cb3f6f10f6829b0f0beac21be8d0ea2eebf427890e677651a887d6fb0b08a9942167d588a0120374d9c8dda342b15b363077d760db36fe9cf874dc0085d17f278b7728b25ef57186c2f58799ba2d7b36ee686d4abfe55410dc31db0371acc3f46ab242e229cb53b47b03c875ea2d83b99209c5e40b8497a33e9fc3a6ca39aa05d24c3f1b1b92c232c423d070a29e095280ed1dd7ba825a039027e3216cf04b9d19c0a7a1ae48de859097ba3a46e0aac09efdb18d3801c18a324b583d0e5483a0d69b996d00af45cdb8e0005b9b517c898406323a121bf8399076f09889015ca77969f2d06c0130cad31d1f46d7d710c47aeb4e5dd929892f3f31f572de9a7f2bdd20ee23081d792ad783fe82516917cf66a1cf2a7c802d60d617f8c82200a239b4652147dde486b8791a7b4a67f10a0c680e9e0040d8f77c20d868b40ae236da8489950fc5959db936d27450dbd6b1127dbc0dc4612c6cf51e56e5ee0fdc1a0cf8497c8feb3691b9e7129fe115c7326c3feb60f3f11620b7d5e10a4a5bb413751329a7626589adedaa856516938dfcc08db9e69434a4c2797e99dbd8158a20180a7df6d5c18a8ccdcf9b379c52dd5f4e941919d4436f8c9f5877e8cd9d883e7b49bf41271a68656466896c23c2b71f4106d2ee487cf8337e7cc036e3ea0ccd106b5c992897d51ba84ed6a56c4ca6a0ce195dd93c6de1b2274bf7bcb7a10087f3ea5d92df0e21262d7fd7e93a55795305474c421733f2678f29db6a4fe4c9d8dc5e529ef0fabf68b35ca69ec2fcd471e3ab5a9105c199fef1fb73bf3f35746149ac45d61b9df0f38741e331e764b1c94f33818f1f44b3eb068b7d61ff51b4ef56d631181f097d26dcc281752928f7c5590864a46ce85b2d6cb480585aed587b9ac9989f535907df5e22e924162367f3ef6eccd3cf8282b7d1f3fd76aba2c9d6ec3220c5801c6ffb44f6f1f99475784ca36979bc3d320b5e158edcf99277793969d1044a5b7eda349c3eb546333b41e6e75632c872a26ea08bb296c9e3664c0b6efe2c8f66927b647cf46abd05d1954fe28062edd2cf55c9a6a5e597653ba1988dc3646a7703f84c2134edb6489c522c497e23f29833cb6307d2796fc1ece85bcd3c27cad7f7cafe4f4ca1130b73e66a72da512f5f03401c66c9704c3f9007de30789b2d6bff61b2ff3e825be9b5c969fd0e0d5a426583744d298a44a288e558c2a0ca2eabb8fec4a92df1e46fe4bbc207e36292509c0200867232b4ecee126c779bc78ca404c883b26d444cd3b592cdd2682d7959ef4e795d2291880d8375aa3b461cdeaefdb573280010ba255ff5cb24e5a417f087253376456a2229034fa55c03853b6f59caa6778ad33925892a36e6f4a77607b8bf28901d77da77d3ac662fb36c1ea39ab4dddb4e2df4445cd1e31fabb0dcf84a54af21fa820d2c82f01af4702fc1f3f52409a9ac4a0458309b529f0f8d80fe9c7c3b48f7b41d6766a235731b14ed78ee4a4c52ae0252e4a07719811a1c35dd2d0b9fadb2641d890e69d9c2f71a968ad22e118f4cd3e1d2528a0b4aa429215cbb06770447b354f9e303801d97ce61cdc49ae427daf6a14b6deff555a09ae4b0a435d872bf0a4d8e3bb82c22ec90a8b68ea4dd3c44af4ad42df16d0a65881ce75c55204e13254b84bcd2858d77c1c34515a805aa69f9e96996d11e7a672880ee24d188efb572a4907397f2e01d707d1e7fbcfa0ab048f5f312d1d7ef4a94100fdd68b9f9f6b7ad7c1e2dc5b77269b2ae1e13f3392f1f39eeaf609c8205a0a6b5d6a5c2844c7f56bc219df60be596c9dd43e3b2827fef473340360f5d8dcc9097b5027454ffdfe11be0ac620ba2f54b1a71a448a0131bfb64d31d72680b854410178f1102da1a9745d3f92990734a17ae99072aae0b033f82681eac128630da8101aeb236726a81320e487078e20919fb571d4c5d8f943d8caef41bf7b36fbc272593e55088b0d08c881ca316b13569f4e6b8bacab3ee1a7b1e4f9fd81a7c3c8c8bdb93e8034d610229f0b19a78d69dd69d060adc4a1390d34b0fbedb8633f313aa25449307d241085826f5de6d3e06125ba22a34ef321c2b1555445ec54f3b8d240185078f29165db8c57f8ff1cdc5bc4968d0f40d89b8f855831484046432c08c0f5de646e68c4c12c27366f1946cab0aa45f4f5e961eb66feb0e239175233360a9bac52f6f4937d6ffc5314946ed2117ad20f22fd032e2458b789d4b09dc11ce282efac3f5ca4593f87660cd89a78768716f409d1a9beb5cd3faa84549858b5915db9857500f5613d2ab7c48df1a4bf192288e99d463e832d89c28d92189658316bd9a16eef4f2de0a9cfda8d89ac99763445df42aae6d4f491f2c84f6c166b2061eab546bee869f41c03bdfa8a83ad2eb443213ad1eb3d295d82a64facecf412da6e9df32bfb29395ccd20f29879ca2f8793b5167dc9f5f1de7598ab3e2971b7335ec196089acde6909fa76cd18b44195b0780e61ab9a6718bb706b722f2b1d1ef6525941c97f3be44326d3dba8fa2f5bc8df5c14dcce93b6fca480748252e7dc4831f5f56d3e3d4e8d25965a457367827c3b580d8f93d7213ab90dfa79bb0c1cc1daebfb8f01d543fb27039620176816917d0106708588ecb5f01da30ea0ffea49d6c87ee6c9323e35ccf86a6f410da39ce5e5b4a1df7d5210d73bcdcb07a74d7783228fc1c2677329f1fdc09caae884c74fdbe0b6d9f7eea0c40c16974220ae423b04555289e4b1f9bb23d9079aea2bcd0e43933945a13984f7fb1143f18c3b5dd087fd55a061ff73ff5e5a4f816215b943f7be8027a35def8878bc1c8e7fecb59a27b6f3ae770627d872ad5bc01ba4b7a7464f2b525808a6e396c3ed823800f1c657bd2100273cc1c0f8037f1f5daac03b6bcdffbd5d896dfac386c4baab30cdc24edf30f52729628f962dc833f5de46c9861f5ac76b0c99722c65d225430563fa2bfe7c9f5125678ea43d3864c253276c7a1b6bf27bb4bf0e6bba5f8dbb0e141e8e5400a143245009ceaeeabf15c4c8cc18e62c89f765a094ba604db7c2fef281172f495345c1642a31361681b3bd4923702d1d90a1f4bee2a34d9f2366e3d6e82c27b97f12a37faeb80a95464bb9d36a62eef42f9a5b9747f425be7418b5b0851ae6dbd5d862a1df632781abcbad300ac94930bde43933648397e65b373946f7e14e517f5b2fedf5c3ca9f8a62e6f49e217c3d580142d2c3ecfd848ad1eef68cc881cc0ffb3370f92ad22b02b749cb91a4fce260ad590ddbce594b2ab14f332841ecb237137cf8f379a860f5baaab87a15bc09278410a01b01fca346eaf8fa9dd35a7f2b74beb5ba3562ef92fd82b471e42d99977fb71b3aefcd4a5a5001450859d5285702bf289005df81994f3adf5f54b5ebb6acf646d11e8c09a6edfc5a1921460589240566a570899d7652430c72e3fff9529a05536bd9611fc23c4e23bb1b4e97e3e0dd7e166323b9276a445c1afc2383bbcfde77f6cb73b570ed97535bc3fe361e84f6a8b0146fd5f4870e773120b3d79a33307911f6aa26e7bf92046b910480b0596bf5af8979e48fe63086ba1b1985e10475454b7b65a4882c4d7458016c699eade1d9893e5f39e22097712365434d510f35b4a310d2d95d208b07b84113e32150747ce37d99e42f8e6003deb17f73b8a677917b13cdc5a1f5df3eb6887072ca2cc878f6d7c9f39ad691d21b05e797b4c454d190018aa21071df192606ab61e649f1b2b4fdcf346e5fb67c84f9415dca3c4a54a556d7ac449542c077606e70d3ee2e0070719dc4231c8827fcb2c9f7d8329fdfbec2ca31baf39c5260000"

// target index of output
const idx = 0
const blindKey = "37b6ccbf216f5b0ffe0194e42d66ecdce68f208286ecd37f5ddf8516ab1fc373"

func TestWallyAssetUnblind(t *testing.T) {
	expectedAsset := [32]uint8{
		0xf3, 0x86, 0x11, 0xeb, 0x68, 0x8e, 0x6f, 0xcd,
		0x6, 0xf2, 0x5e, 0x2f, 0xaf, 0x52, 0xb9, 0xf9,
		0x83, 0x64, 0xdc, 0x14, 0xc3, 0x79, 0xab, 0x8,
		0x5f, 0x1b, 0x57, 0xd5, 0x6b, 0x4b, 0x1a, 0x6f}
	expectedABF := [32]uint8{
		0x62, 0xe3, 0xb0, 0x7d, 0x9b, 0x2f, 0xca, 0x9a,
		0x51, 0x63, 0x6, 0x32, 0xd2, 0xd2, 0xe8, 0x53,
		0xa, 0xb, 0x8e, 0x27, 0xf4, 0xa1, 0x93, 0x92,
		0x57, 0xc8, 0x97, 0x7f, 0x8e, 0x36, 0x82, 0xc3}
	expectedVBF := [32]uint8{
		0x9, 0x66, 0x84, 0xf9, 0xab, 0x5b, 0x1e, 0x67,
		0x98, 0x7a, 0xfe, 0x7d, 0xfc, 0x6a, 0x80, 0xa1,
		0xca, 0x7e, 0x5, 0x8a, 0x10, 0xdd, 0xaa, 0xc7,
		0x41, 0x75, 0x6c, 0x6, 0x75, 0xe6, 0xf6, 0x78}
	expectedValue := uint64(88000000)
	tx, _ := WallyTxFromHex(TX, uint32(3))
	txOut := tx.ListOutputs()[idx]
	blindKeyBytes,_ := hex.DecodeString(blindKey)
	asset, abf, value, vbf, _ := WallyAssetUnblind(
        txOut.NonceToBytes(),
        blindKeyBytes,
        txOut.RangeproofToBytes(),
        txOut.ValueToBytes(),
        txOut.ScriptToBytes(),
        txOut.AssetToBytes(),
    )

    assert.Equal(t, expectedAsset, asset)
    assert.Equal(t, expectedABF, abf)
    assert.Equal(t, expectedVBF, vbf)
    assert.Equal(t, expectedValue, value)
}